{% extends "base.html" %}



{% block content %}
<div class="max-w-7xl mx-auto p-4 md:p-8 space-y-6">
    <!-- Page header -->
    <div class="flex items-center gap-4">
        <a href="javascript:history.back()" class="btn btn-ghost btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
            Back
        </a>
        <h1 class="text-2xl md:text-3xl font-bold">Job Details</h1>
        <div class="flex-1"></div>
        <button hx-delete="/jobs/{{ job.job_id }}" hx-confirm="Delete this job? This cannot be undone." hx-target="body"
            hx-swap="outerHTML" onclick="setTimeout(()=>window.location.href='/jobs', 500)"
            class="btn btn-error btn-outline btn-sm gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
            </svg>
            Delete Job
        </button>
    </div>

    <div class="grid grid-cols-1 gap-6 {% if job.schedule %}lg:grid-cols-3{% else %}lg:grid-cols-2{% endif %}">
        <!-- Basic Info -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Basic Information</h2>
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <th class="w-40">Job ID</th>
                                <td class="font-mono text-sm">{{ job.job_id }}</td>
                            </tr>
                            <tr>
                                <th>Provider</th>
                                <td>{{ job.provider if job.provider is string else job.provider.value }}</td>
                            </tr>
                            <tr>
                                <th>Meeting Code</th>
                                <td class="font-mono">{{ job.meeting_code }}</td>
                            </tr>
                            <tr>
                                <th>Display Name</th>
                                <td>{{ job.display_name or '-' }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% if job.schedule %}
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Schedule Information</h2>
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <th class="w-40">Schedule Config</th>
                                <td>
                                    <a href="/schedules/{{ job.schedule.id }}/edit"
                                        class="link flex items-center gap-2">
                                        {{ job.schedule.meeting.name }}
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                            stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M13.5 6H5.25A2.25 2.25 0 003 8.25v10.5A2.25 2.25 0 005.25 21h10.5A2.25 2.25 0 0018 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
                                        </svg>
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <th>Schedule Type</th>
                                <td>
                                    <span class="badge badge-sm badge-outline">
                                        {{ job.schedule.schedule_type if job.schedule.schedule_type is string else
                                        job.schedule.schedule_type.value }}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th>Scheduled Time</th>
                                <td class="font-mono">
                                    {% if job.schedule.cron_expression %}
                                    CRON: {{ job.schedule.cron_expression }}
                                    {% elif job.schedule.start_time %}
                                    {{ job.schedule.start_time | localtime }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Configured Duration</th>
                                <td>
                                    {{ (job.schedule.duration_sec / 60) | int }} mins
                                    {% if job.schedule.duration_mode == 'auto' %} (Auto){% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Timestamps -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Timeline</h2>
                <ul class="steps steps-vertical w-full">
                    <!-- Created/Started -->
                    <li class="step step-primary">
                        <div class="text-left w-full">
                            <div class="font-medium">Job Created</div>
                            <div class="text-xs text-base-content/60 font-mono">
                                {{ job.created_at | localtime }}
                            </div>
                        </div>
                    </li>

                    <!-- Joined/Running -->
                    <li class="step {% if job.joined_at %}step-primary{% endif %}">
                        <div class="text-left w-full">
                            <div class="font-medium flex items-center gap-2">
                                Joined Meeting
                                {% if not job.joined_at and job.status.value in ['joining', 'waiting_lobby'] %}
                                <span class="loading loading-spinner loading-xs text-primary"></span>
                                {% endif %}
                            </div>
                            {% if job.joined_at %}
                            <div class="text-xs text-base-content/60 font-mono">
                                {{ job.joined_at | localtime }}
                            </div>
                            {% endif %}
                        </div>
                    </li>

                    <!-- Recording -->
                    <li class="step {% if job.recording_started_at %}step-primary{% endif %}">
                        <div class="text-left w-full">
                            <div class="font-medium flex items-center gap-2">
                                Recording Started
                                {% if not job.recording_started_at and job.status.value == 'recording' %}
                                <span class="loading loading-spinner loading-xs text-primary"></span>
                                {% endif %}
                            </div>
                            {% if job.recording_started_at %}
                            <div class="text-xs text-base-content/60 font-mono">
                                {{ job.recording_started_at | localtime }}
                            </div>
                            {% endif %}
                        </div>
                    </li>

                    <!-- Final Status (Success/Failed/Canceled) -->
                    {% set status_val = job.status.value if job.status is not string else job.status %}
                    <li class="step {% if status_val in ['succeeded', 'failed', 'canceled'] %}step-primary{% endif %}">
                        <div class="text-left w-full">
                            {% if status_val == 'succeeded' %}
                            <div class="font-bold text-success flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                    stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                                </svg>
                                Completed Successfully
                            </div>
                            {% elif status_val == 'failed' %}
                            <div class="font-bold text-error flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                    stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                                Failed
                            </div>
                            {% elif status_val == 'canceled' %}
                            <div class="font-bold text-warning flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                    stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                                </svg>
                                Canceled
                            </div>
                            {% else %}
                            <div class="font-medium text-base-content/50">Completed</div>
                            {% endif %}

                            {% if job.completed_at %}
                            <div class="text-xs text-base-content/60 font-mono">
                                {{ job.completed_at | localtime }}
                            </div>
                            {% endif %}
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    {% if job.status.value == 'succeeded' and job.output_path %}
    <!-- Recording Info -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">Recording</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <div class="text-sm text-base-content/60">Duration</div>
                    <div class="font-medium">{{ (job.duration_actual_sec / 60) | int if job.duration_actual_sec else
                        0
                        }} minutes</div>
                </div>
                <div>
                    <div class="text-sm text-base-content/60">File Size</div>
                    <div class="font-medium">{{ (job.file_size / 1024 / 1024) | round(1) if job.file_size else 0 }}
                        MB
                    </div>
                </div>
                <div>
                    <div class="text-sm text-base-content/60">Output Path</div>
                    <div class="font-mono text-sm truncate">{{ job.output_path }}</div>
                </div>
            </div>
            <div class="card-actions justify-end mt-4">
                <a href="/recordings/{{ job.job_id }}/download" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                        stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    Download Recording
                </a>
            </div>
            {% if job.youtube_video_id %}
            <div class="divider">YouTube</div>
            <div class="flex items-center gap-4">
                <span class="badge badge-success">Uploaded</span>
                <a href="https://youtu.be/{{ job.youtube_video_id }}" target="_blank" class="link">
                    https://youtu.be/{{ job.youtube_video_id }}
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if job.status.value in ['failed', 'canceled'] %}
    <!-- Error Info -->
    <div class="card bg-error/10 shadow-xl">
        <div class="card-body">
            <h2 class="card-title text-error">
                {% if job.status.value == 'canceled' %}Canceled{% else %}Error Information{% endif %}
            </h2>
            <div class="space-y-4">
                {% if job.error_code %}
                <div>
                    <div class="text-sm text-base-content/60">Error Code</div>
                    <div class="font-mono text-error">{{ job.error_code.value }}</div>
                </div>
                <div>
                    <div class="text-sm text-base-content/60">Description</div>
                    {% set error_descriptions = {
                    'JOIN_TIMEOUT': 'Unable to join meeting within timeout',
                    'JOIN_FAILED': 'Failed to join meeting',
                    'INVALID_URL': 'Invalid meeting URL',
                    'MEETING_NOT_FOUND': 'Meeting does not exist',
                    'PASSWORD_REQUIRED': 'Password required',
                    'PASSWORD_INCORRECT': 'Incorrect password',
                    'LOBBY_TIMEOUT': 'Lobby wait timeout (not admitted)',
                    'LOBBY_REJECTED': 'Rejected by host',
                    'RECORDING_START_FAILED': 'Recording startup failed',
                    'RECORDING_INTERRUPTED': 'Recording interrupted',
                    'FFMPEG_ERROR': 'FFmpeg error',
                    'BROWSER_CRASHED': 'Browser crashed',
                    'VIRTUAL_ENV_ERROR': 'Virtual environment error',
                    'DISK_FULL': 'Disk full',
                    'CANCELED': 'Canceled by user',
                    'INTERNAL_ERROR': 'Internal error'
                    } %}
                    <div class="text-error">{{ error_descriptions.get(job.error_code.value, job.error_code.value) }}
                    </div>
                </div>
                {% endif %}
                {% if job.error_message %}
                <div>
                    <div class="text-sm text-base-content/60">Error Message</div>
                    <div class="text-error">{{ job.error_message }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% if job.diagnostic_dir %}
    <!-- Diagnostics -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">Diagnostics</h2>
            <div class="text-sm text-base-content/60 mb-4">
                Diagnostic data collected at: <code>{{ job.diagnostic_dir }}</code>
            </div>
            <div class="flex gap-4 flex-wrap">
                {% if job.has_screenshot %}
                <div class="flex-1 min-w-[300px]">
                    <div class="text-sm font-medium mb-2">Screenshot</div>
                    <img src="/jobs/{{ job.job_id }}/diagnostics/screenshot" alt="Failure screenshot"
                        class="rounded-lg border border-base-300 max-w-full">
                </div>
                {% endif %}
                <div class="flex flex-col gap-2">
                    {% if job.has_html_dump %}
                    <span class="badge badge-outline">HTML dump available</span>
                    {% endif %}
                    {% if job.has_console_log %}
                    <span class="badge badge-outline">Console log available</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>
{% endblock %}