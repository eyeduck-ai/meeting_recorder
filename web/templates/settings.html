{% extends "base.html" %}



{% block content %}
<div class="h-full flex flex-col md:flex-row max-w-7xl mx-auto">

    <!-- Settings Sidebar (Desktop) / Tabs (Mobile) -->
    <div class="w-full md:w-64 md:border-r border-[#2f3336] flex-shrink-0">
        <h2 class="text-2xl md:text-3xl font-bold px-4 pt-4 md:pt-8 pb-4 hidden md:block">Settings</h2>

        <!-- Mobile Tabs (Horizontal Scroll) -->
        <div class="md:hidden flex overflow-x-auto border-b border-[#2f3336] no-scrollbar">
            <button onclick="switchTab('general')"
                class="tab-btn active px-4 py-3 whitespace-nowrap font-bold border-b-2 border-primary">General</button>
            <button onclick="switchTab('recording')"
                class="tab-btn px-4 py-3 whitespace-nowrap text-gray-500">Recording</button>
            <button onclick="switchTab('integrations')"
                class="tab-btn px-4 py-3 whitespace-nowrap text-gray-500">Integrations</button>
            <button onclick="switchTab('detection')"
                class="tab-btn px-4 py-3 whitespace-nowrap text-gray-500">Detection</button>
            <button onclick="switchTab('notifications')"
                class="tab-btn px-4 py-3 whitespace-nowrap text-gray-500">Notifications</button>
        </div>

        <!-- Desktop Sidebar Menu -->
        <div class="hidden md:flex flex-col py-2">
            <button onclick="switchTab('general')"
                class="tab-btn active text-left px-4 py-3 hover:bg-[#181818] border-r-2 border-primary transition-colors font-bold">General
                & Storage</button>
            <button onclick="switchTab('recording')"
                class="tab-btn text-left px-4 py-3 hover:bg-[#181818] border-r-2 border-transparent transition-colors text-gray-500">Recording
                Config</button>
            <button onclick="switchTab('integrations')"
                class="tab-btn text-left px-4 py-3 hover:bg-[#181818] border-r-2 border-transparent transition-colors text-gray-500">Integrations</button>
            <button onclick="switchTab('detection')"
                class="tab-btn text-left px-4 py-3 hover:bg-[#181818] border-r-2 border-transparent transition-colors text-gray-500">Meeting
                Detection</button>
            <button onclick="switchTab('notifications')"
                class="tab-btn text-left px-4 py-3 hover:bg-[#181818] border-r-2 border-transparent transition-colors text-gray-500">Notifications</button>
        </div>
    </div>

    <!-- Content Area -->
    <div class="flex-1 overflow-y-auto">

        <!-- General Section -->
        <div id="section-general" class="settings-section p-4 md:p-8 max-w-2xl">
            <h3 class="text-xl font-bold mb-6">System Information</h3>

            <div class="mb-8">
                <div class="flex justify-between py-3 border-b border-[#2f3336]">
                    <span class="text-gray-500">Max Duration</span>
                    <span>{{ settings.max_recording_sec }} sec</span>
                </div>
                <div class="flex justify-between py-3 border-b border-[#2f3336]">
                    <span class="text-gray-500">Save Path</span>
                    <span class="font-mono text-sm">{{ settings.recordings_dir }}</span>
                </div>
                <div class="flex justify-between py-3 border-b border-[#2f3336]">
                    <span class="text-gray-500">Database</span>
                    <span class="font-mono text-sm">{{ settings.database_url }}</span>
                </div>
            </div>

            <h3 class="text-xl font-bold mb-4">Storage Management</h3>
            <div class="bg-[#16181c] rounded-xl p-4 border border-[#2f3336]">
                <div class="grid grid-cols-3 gap-4 mb-4 text-center">
                    <div>
                        <div class="text-sm text-gray-500">Free Space</div>
                        <div class="text-xl font-bold text-success" id="disk-free">-</div>
                        <div class="text-xs text-gray-500">GB</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Recordings</div>
                        <div class="text-xl font-bold text-white" id="rec-size">-</div>
                        <div class="text-xs text-gray-500"><span id="rec-count">0</span> files</div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Usage</div>
                        <div class="text-xl font-bold text-white" id="disk-usage">-</div>
                        <div class="text-xs text-gray-500">%</div>
                    </div>
                </div>

                <div class="flex flex-wrap gap-3 justify-end">
                    <button onclick="refreshDiskUsage()" class="btn btn-sm btn-ghost rounded-full">Refresh</button>
                    <button onclick="cleanupRecordings(true)" class="btn btn-sm btn-outline rounded-full">Preview
                        Cleanup</button>
                    <button onclick="cleanupRecordings(false)"
                        class="btn btn-sm btn-error btn-outline rounded-full">Clean Old (>30d)</button>
                </div>
            </div>
        </div>

        <!-- Recording Section -->
        <div id="section-recording" class="settings-section hidden p-4 md:p-8 max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Recording Configuration</h3>
                <button onclick="saveSettings()" class="btn btn-primary btn-sm rounded-full px-6">Save</button>
            </div>

            <form id="settings-form" class="space-y-6">
                <!-- Resolution -->
                <div class="form-group">
                    <label class="block text-sm font-bold mb-2">Resolution</label>
                    <select id="resolution-select"
                        class="select select-bordered w-full bg-black border-[#2f3336] focus:border-primary"
                        onchange="updateResolution()">
                        <option value="1920x1080" {% if app_settings.resolution_w=='1920' and
                            app_settings.resolution_h=='1080' %}selected{% endif %}>1080p (1920x1080)</option>
                        <option value="1280x720" {% if app_settings.resolution_w=='1280' and
                            app_settings.resolution_h=='720' %}selected{% endif %}>720p (1280x720)</option>
                        <option value="custom" {% if app_settings.resolution_w not in ['1920', '1280' ] %}selected{%
                            endif %}>Custom</option>
                    </select>
                    <div id="custom-resolution"
                        class="grid grid-cols-2 gap-4 mt-2 {% if app_settings.resolution_w in ['1920', '1280'] %}hidden{% endif %}">
                        <input type="number" id="resolution_w" value="{{ app_settings.resolution_w }}"
                            class="input input-bordered bg-black border-[#2f3336]" placeholder="Width">
                        <input type="number" id="resolution_h" value="{{ app_settings.resolution_h }}"
                            class="input input-bordered bg-black border-[#2f3336]" placeholder="Height">
                    </div>
                </div>

                <!-- FFmpeg Preset -->
                <div class="form-group">
                    <label class="block text-sm font-bold mb-2">FFmpeg Preset <span
                            class="text-gray-500 font-normal">(Speed vs Quality)</span></label>
                    <select id="ffmpeg_preset"
                        class="select select-bordered w-full bg-black border-[#2f3336] focus:border-primary">
                        <option value="ultrafast" {% if app_settings.ffmpeg_preset=='ultrafast' %}selected{% endif %}>
                            ultrafast (fastest, larger files)</option>
                        <option value="superfast" {% if app_settings.ffmpeg_preset=='superfast' %}selected{% endif %}>
                            superfast</option>
                        <option value="veryfast" {% if app_settings.ffmpeg_preset=='veryfast' %}selected{% endif %}>
                            veryfast (default)</option>
                        <option value="faster" {% if app_settings.ffmpeg_preset=='faster' %}selected{% endif %}>faster
                        </option>
                        <option value="fast" {% if app_settings.ffmpeg_preset=='fast' %}selected{% endif %}>fast
                        </option>
                        <option value="medium" {% if app_settings.ffmpeg_preset=='medium' %}selected{% endif %}>medium
                        </option>
                    </select>
                </div>

                <!-- Timings -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-bold mb-2">Lobby Timeout (sec)</label>
                        <input type="number" id="lobby_wait_sec" value="{{ app_settings.lobby_wait_sec }}"
                            class="input input-bordered w-full bg-black border-[#2f3336]">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-2">Pre-join Offset (sec)</label>
                        <input type="number" id="pre_join_seconds" value="{{ app_settings.pre_join_seconds }}"
                            class="input input-bordered w-full bg-black border-[#2f3336]">
                    </div>
                </div>

                <!-- URL & TZ -->
                <div>
                    <label class="block text-sm font-bold mb-2">Jitsi Base URL</label>
                    <input type="url" id="jitsi_base_url" value="{{ app_settings.jitsi_base_url }}"
                        class="input input-bordered w-full bg-black border-[#2f3336]"
                        placeholder="https://meet.jit.si/">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-2">Timezone</label>
                    <input type="text" id="tz" value="{{ app_settings.tz }}"
                        class="input input-bordered w-full bg-black border-[#2f3336]" placeholder="Asia/Taipei">
                </div>
            </form>
        </div>

        <!-- Integrations Section -->
        <div id="section-integrations" class="settings-section hidden p-4 md:p-8 max-w-2xl">

            <!-- YouTube -->
            <div class="mb-10">
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-red-500">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z" />
                        </svg>
                    </span>
                    YouTube Integration
                </h3>

                <div class="bg-[#16181c] rounded-xl p-6 border border-[#2f3336]">
                    {% if not youtube_status.configured %}
                    <div class="text-warning mb-4">API not configured. Set ENV variables.</div>
                    {% else %}
                    {% if youtube_status.authorized %}
                    <div class="flex items-center justify-between">
                        <span class="text-green-500 font-bold">âœ“ Connected</span>
                        <button class="btn btn-sm btn-outline btn-error rounded-full"
                            hx-post="/api/v1/youtube/auth/revoke"
                            hx-on::after-request="location.reload()">Disconnect</button>
                    </div>
                    {% else %}
                    <p class="mb-4 text-gray-500">Connect to enable auto-upload.</p>
                    <div id="auth-container">
                        <button id="start-auth-btn" class="btn btn-primary rounded-full w-full"
                            onclick="startYouTubeAuth()">Connect Account</button>
                    </div>
                    <div id="auth-instructions" class="hidden mt-4 bg-base-300 p-4 rounded-lg">
                        <p>1. Visit <a id="auth-url" href="#" target="_blank" class="link text-primary">this link</a>
                        </p>
                        <p>2. Enter code: <strong id="auth-code" class="text-lg text-white"></strong></p>
                        <div class="mt-2 text-sm text-gray-500" id="poll-status">Waiting...</div>
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Telegram -->
            <div>
                <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-blue-400">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.08.1.05.19.12.24.2.04.1.06.2.06.31z" />
                        </svg>
                    </span>
                    Telegram Bot
                </h3>

                {% if not telegram_status.configured %}
                <div class="text-warning">Bot token not configured.</div>
                {% else %}
                <div class="bg-[#16181c] rounded-xl border border-[#2f3336] overflow-hidden">
                    <div class="p-4 border-b border-[#2f3336]">
                        <h4 class="font-bold">Authorized Users</h4>
                    </div>
                    <div id="telegram-users-container" class="p-4">
                        <span class="loading loading-spinner"></span> Loading...
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Detection Section -->
        <div id="section-detection" class="settings-section hidden p-4 md:p-8 max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">End Detection Config</h3>
                <button onclick="saveDetectionConfig()" class="btn btn-primary btn-sm rounded-full px-6"
                    id="btn-save-detection">Save</button>
            </div>

            <p class="text-gray-500 mb-6">Conditions to trigger automatic stop.</p>

            <div class="space-y-4">
                <div class="flex items-center justify-between p-3 border-b border-[#2f3336]">
                    <div>
                        <div class="font-bold">WebRTC Connection</div>
                        <div class="text-xs text-gray-500">Browser connection state</div>
                    </div>
                    <input type="checkbox" id="det_webrtc" class="toggle toggle-primary">
                </div>
                <div class="flex items-center justify-between p-3 border-b border-[#2f3336]">
                    <div>
                        <div class="font-bold">Text Indicators</div>
                        <div class="text-xs text-gray-500">"Meeting ended"</div>
                    </div>
                    <input type="checkbox" id="det_text" class="toggle toggle-primary">
                </div>
                <div class="flex items-center justify-between p-3 border-b border-[#2f3336]">
                    <div>
                        <div class="font-bold">Video Element</div>
                        <div class="text-xs text-gray-500">Video tag removal</div>
                    </div>
                    <input type="checkbox" id="det_video" class="toggle toggle-primary">
                </div>
                <div class="flex items-center justify-between p-3 border-b border-[#2f3336]">
                    <div>
                        <div class="font-bold">URL Change</div>
                        <div class="text-xs text-gray-500">Navigation away</div>
                    </div>
                    <input type="checkbox" id="det_url" class="toggle toggle-primary">
                </div>
                <div class="flex items-center justify-between p-3 border-b border-[#2f3336]">
                    <div>
                        <div class="font-bold">Screen Freeze</div>
                        <div class="text-xs text-gray-500">Pixels unchanged</div>
                    </div>
                    <input type="checkbox" id="det_freeze" class="toggle toggle-secondary">
                </div>
            </div>

            <div class="mt-8 grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-bold mb-2">Freeze Timeout (s)</label>
                    <input type="number" id="freeze_timeout"
                        class="input input-bordered w-full bg-black border-[#2f3336]">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-2">Min Detectors</label>
                    <select id="min_detectors" class="select select-bordered w-full bg-black border-[#2f3336]">
                        <option value="1">1 (Fastest)</option>
                        <option value="2">2 (Balanced)</option>
                        <option value="3">3 (Strict)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Notifications Section -->
        <div id="section-notifications" class="settings-section hidden p-4 md:p-8 max-w-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Notifications</h3>
                <button onclick="saveNotificationConfig()"
                    class="btn btn-primary btn-sm rounded-full px-6">Save</button>
            </div>

            <div class="space-y-8">
                <!-- Email -->
                <div>
                    <h4 class="font-bold mb-4 flex items-center gap-2">
                        <input type="checkbox" id="smtp_enabled" class="toggle toggle-sm toggle-info"> Email
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pl-8">
                        <input type="text" id="smtp_host" placeholder="Host"
                            class="input input-bordered input-sm w-full bg-black border-[#2f3336]">
                        <input type="number" id="smtp_port" placeholder="Port"
                            class="input input-bordered input-sm w-full bg-black border-[#2f3336]">
                        <input type="text" id="smtp_user" placeholder="User"
                            class="input input-bordered input-sm w-full bg-black border-[#2f3336]">
                        <input type="password" id="smtp_password" placeholder="Pass"
                            class="input input-bordered input-sm w-full bg-black border-[#2f3336]">
                        <input type="email" id="smtp_from" placeholder="From Addr"
                            class="input input-bordered input-sm w-full bg-black border-[#2f3336]">
                        <input type="text" id="smtp_to" placeholder="To Addr (comma sep)"
                            class="input input-bordered input-sm w-full bg-black border-[#2f3336]">
                    </div>
                    <button onclick="testEmail()" class="btn btn-xs btn-ghost mt-2 ml-8">Send Test</button>
                </div>

                <!-- Webhook -->
                <div>
                    <h4 class="font-bold mb-4 flex items-center gap-2">
                        <input type="checkbox" id="webhook_enabled" class="toggle toggle-sm toggle-info"> Webhook
                    </h4>
                    <div class="grid grid-cols-1 gap-4 pl-8">
                        <input type="url" id="webhook_url" placeholder="Webhook URL"
                            class="input input-bordered input-sm w-full bg-black border-[#2f3336]">
                        <input type="password" id="webhook_secret" placeholder="Secret (Optional)"
                            class="input input-bordered input-sm w-full bg-black border-[#2f3336]">
                    </div>
                    <button onclick="testWebhook()" class="btn btn-xs btn-ghost mt-2 ml-8">Send Test</button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    // Tab Switching Logic
    function switchTab(tabId) {
        // Hide all sections
        document.querySelectorAll('.settings-section').forEach(el => el.classList.add('hidden'));
        // Show target section
        document.getElementById('section-' + tabId).classList.remove('hidden');

        // Update styling
        document.querySelectorAll('.tab-btn').forEach(btn => {
            // Basic logic to reset classes (simplistic for now)
            btn.classList.remove('active', 'border-primary', 'font-bold', 'text-white');
            btn.classList.add('text-gray-500', 'border-transparent');

            // If it matches the tabId name in text or onclick (bit hacky but effective for simple tabs)
            if (btn.getAttribute('onclick').includes(tabId)) {
                btn.classList.add('active', 'border-primary', 'font-bold', 'text-white');
                btn.classList.remove('text-gray-500', 'border-transparent');
            }
        });
    }

    // Reuse existing functional logic (YouTube, Telegram, etc.)
    // ... Copying the essential JS functions ...
    let pollInterval = null;
    let currentDeviceCode = null;

    async function startYouTubeAuth() {
        const btn = document.getElementById('start-auth-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading loading-spinner"></span>';
        try {
            const response = await fetch('/api/v1/youtube/auth/start', { method: 'POST' });
            const data = await response.json();
            if (data.verification_url) {
                currentDeviceCode = data.device_code;
                document.getElementById('auth-url').href = data.verification_url;
                document.getElementById('auth-code').textContent = data.user_code;
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('auth-instructions').classList.remove('hidden');
                pollInterval = setInterval(pollForToken, data.interval * 1000 || 5000);
            }
        } catch (e) { console.error(e); btn.disabled = false; btn.textContent = 'Retry'; }
    }

    async function pollForToken() {
        if (!currentDeviceCode) return clearInterval(pollInterval);
        try {
            const res = await fetch('/api/v1/youtube/auth/poll', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device_code: currentDeviceCode })
            });
            const data = await res.json();
            if (data.success) location.reload();
        } catch (e) { }
    }

    // Telegram Logic
    async function loadTelegramUsers() {
        const container = document.getElementById('telegram-users-container');
        try {
            const res = await fetch('/api/v1/telegram/users');
            const users = await res.json();
            if (users.length === 0) {
                container.innerHTML = '<div class="text-gray-500">No users yet.</div>';
                return;
            }
            let html = '';
            for (const u of users) {
                html += `<div class="flex justify-between items-center py-2 border-b border-[#2f3336] last:border-0">
                    <div>
                        <div class="font-bold text-sm">${u.username || u.first_name || u.chat_id}</div>
                        <div class="text-xs text-gray-500">${u.chat_id}</div>
                    </div>
                    <div class="flex gap-2">
                        ${!u.approved ? `<button onclick="approveUser(${u.id})" class="btn btn-xs btn-success">Approve</button>` : `<button onclick="revokeUser(${u.id})" class="btn btn-xs btn-warning">Revoke</button>`}
                        <button onclick="deleteUser(${u.id})" class="btn btn-xs btn-error btn-outline">Del</button>
                    </div>
                 </div>`;
            }
            container.innerHTML = html;
        } catch (e) { container.innerHTML = 'Error loading users'; }
    }

    // Stub functions for actions
    async function approveUser(id) { await fetch(`/api/v1/telegram/users/${id}/approve`, { method: 'POST', body: JSON.stringify({ approved_by: 'admin' }), headers: { 'Content-Type': 'application/json' } }); loadTelegramUsers(); }
    async function revokeUser(id) { await fetch(`/api/v1/telegram/users/${id}/revoke`, { method: 'POST' }); loadTelegramUsers(); }
    async function deleteUser(id) { if (confirm('Del?')) { await fetch(`/api/v1/telegram/users/${id}`, { method: 'DELETE' }); loadTelegramUsers(); } }

    function updateResolution() {
        const val = document.getElementById('resolution-select').value;
        const custom = document.getElementById('custom-resolution');
        if (val === 'custom') custom.classList.remove('hidden');
        else {
            custom.classList.add('hidden');
            const [w, h] = val.split('x');
            document.getElementById('resolution_w').value = w;
            document.getElementById('resolution_h').value = h;
        }
    }

    async function saveSettings() {
        const data = {
            resolution_w: parseInt(document.getElementById('resolution_w').value),
            resolution_h: parseInt(document.getElementById('resolution_h').value),
            ffmpeg_preset: document.getElementById('ffmpeg_preset').value,
            lobby_wait_sec: parseInt(document.getElementById('lobby_wait_sec').value),
            pre_join_seconds: parseInt(document.getElementById('pre_join_seconds').value),
            jitsi_base_url: document.getElementById('jitsi_base_url').value,
            tz: document.getElementById('tz').value
        };
        try {
            const res = await fetch('/api/v1/settings', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            if (res.ok) alert('Saved'); else alert('Error saving');
        } catch (e) { alert(e); }
    }

    // Existing load functions
    async function loadDetectionConfig() {
        const res = await fetch('/api/detection/config');
        const c = await res.json();
        document.getElementById('det_webrtc').checked = c.webrtc_connection_enabled;
        document.getElementById('det_text').checked = c.text_indicator_enabled;
        document.getElementById('det_video').checked = c.video_element_enabled;
        document.getElementById('det_url').checked = c.url_change_enabled;
        document.getElementById('det_freeze').checked = c.screen_freeze_enabled;
        document.getElementById('freeze_timeout').value = c.screen_freeze_timeout_sec;
        document.getElementById('min_detectors').value = c.min_detectors_agree;
    }
    async function saveDetectionConfig() {
        const c = {
            webrtc_connection_enabled: document.getElementById('det_webrtc').checked,
            text_indicator_enabled: document.getElementById('det_text').checked,
            video_element_enabled: document.getElementById('det_video').checked,
            url_change_enabled: document.getElementById('det_url').checked,
            screen_freeze_enabled: document.getElementById('det_freeze').checked,
            screen_freeze_timeout_sec: parseInt(document.getElementById('freeze_timeout').value),
            min_detectors_agree: parseInt(document.getElementById('min_detectors').value)
        };
        await fetch('/api/detection/config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(c) });
        alert('Detection Saved');
    }

    // Notification Logic (Restored)
    async function loadNotificationConfig() {
        try {
            const res = await fetch('/api/recordings/notification-config');
            const c = await res.json();
            document.getElementById('smtp_enabled').checked = c.smtp_enabled;
            document.getElementById('smtp_host').value = c.smtp_host || '';
            document.getElementById('smtp_port').value = c.smtp_port || 587;
            document.getElementById('smtp_user').value = c.smtp_user || '';
            document.getElementById('smtp_password').value = c.smtp_password || '';
            document.getElementById('smtp_from').value = c.smtp_from || '';
            document.getElementById('smtp_to').value = (c.smtp_to || []).join(',');
            document.getElementById('webhook_enabled').checked = c.webhook_enabled;
            document.getElementById('webhook_url').value = c.webhook_url || '';
            document.getElementById('webhook_secret').value = c.webhook_secret || '';
        } catch (e) { }
    }

    async function saveNotificationConfig() {
        const c = {
            smtp_enabled: document.getElementById('smtp_enabled').checked,
            smtp_host: document.getElementById('smtp_host').value,
            smtp_port: parseInt(document.getElementById('smtp_port').value),
            smtp_user: document.getElementById('smtp_user').value,
            smtp_password: document.getElementById('smtp_password').value,
            smtp_from: document.getElementById('smtp_from').value,
            smtp_to: document.getElementById('smtp_to').value.split(','),
            webhook_enabled: document.getElementById('webhook_enabled').checked,
            webhook_url: document.getElementById('webhook_url').value,
            webhook_secret: document.getElementById('webhook_secret').value
        };
        await fetch('/api/recordings/notification-config', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(c) });
        alert('Notifications Saved');
    }

    async function testEmail() { await fetch('/api/recordings/test-email', { method: 'POST' }); alert('Test Sent'); }
    async function testWebhook() { await fetch('/api/recordings/test-webhook', { method: 'POST' }); alert('Test Sent'); }

    async function refreshDiskUsage() {
        const res = await fetch('/api/recordings/disk-usage');
        const d = await res.json();
        document.getElementById('disk-free').textContent = d.free_gb.toFixed(1);
        document.getElementById('rec-size').textContent = d.recordings_gb.toFixed(1);
        document.getElementById('rec-count').textContent = d.recordings_count;
        document.getElementById('disk-usage').textContent = d.usage_percent + '%';
    }

    async function cleanupRecordings(dry) {
        if (!dry && !confirm('Sure?')) return;
        const res = await fetch(`/api/recordings/cleanup?max_age_days=30&dry_run=${dry}`, { method: 'POST' });
        const d = await res.json();
        alert(`Deleted: ${d.deleted_count}`);
        refreshDiskUsage();
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadTelegramUsers();
        loadDetectionConfig();
        loadNotificationConfig();
        refreshDiskUsage();
    });
</script>

<!-- Add horizontal scroll hide style -->
<style>
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }

    .no-scrollbar {
        -ms-overflow-style: none;
        /* IE and Edge */
        scrollbar-width: none;
        /* Firefox */
    }
</style>
{% endblock %}