{% extends "base.html" %}

{% block title %}Settings - Meeting Recorder{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page header -->
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold">Settings</h1>
    </div>

    <!-- YouTube Settings -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-red-500">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 010 .656l-5.603 3.113a.375.375 0 01-.557-.328V8.887c0-.286.307-.466.557-.327l5.603 3.112z" />
                </svg>
                YouTube Integration
            </h2>

            <div class="divider"></div>

            {% if not youtube_status.configured %}
            <div class="alert alert-warning">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                <div>
                    <h3 class="font-bold">YouTube API not configured</h3>
                    <div class="text-sm">Set YOUTUBE_CLIENT_ID and YOUTUBE_CLIENT_SECRET environment variables.</div>
                </div>
            </div>
            {% else %}
            <div class="flex items-center gap-4 mb-4">
                <div class="text-sm text-base-content/60">Status:</div>
                {% if youtube_status.authorized %}
                <span class="badge badge-success">Authorized</span>
                {% else %}
                <span class="badge badge-warning">Not Authorized</span>
                {% endif %}
            </div>

            {% if youtube_status.authorized %}
            <div class="alert alert-success">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span>YouTube account is connected. Recordings can be automatically uploaded.</span>
            </div>

            <div class="mt-4">
                <button id="revoke-btn" class="btn btn-outline btn-error"
                        hx-post="/api/v1/youtube/auth/revoke"
                        hx-swap="none"
                        hx-on::after-request="location.reload()">
                    Disconnect YouTube Account
                </button>
            </div>
            {% else %}
            <p class="text-base-content/60 mb-4">
                Connect your YouTube account to enable automatic upload of recordings.
            </p>

            <div id="auth-container">
                <button id="start-auth-btn" class="btn btn-primary"
                        onclick="startYouTubeAuth()">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                    </svg>
                    Connect YouTube Account
                </button>
            </div>

            <div id="auth-instructions" class="hidden mt-4">
                <div class="alert">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-info shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <div>
                        <h3 class="font-bold">Authorization Required</h3>
                        <div class="text-sm mt-2">
                            <p>1. Visit: <a id="auth-url" href="#" target="_blank" class="link font-mono break-all"></a></p>
                            <p>2. Enter code: <code id="auth-code" class="font-bold text-lg"></code></p>
                            <p>3. Complete authorization on Google's website</p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex items-center gap-2">
                    <span class="loading loading-spinner"></span>
                    <span id="poll-status">Waiting for authorization...</span>
                </div>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>

    <!-- Telegram Settings -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-blue-500">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
                </svg>
                Telegram Bot
            </h2>

            <div class="divider"></div>

            {% if not telegram_status.configured %}
            <div class="alert alert-warning">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                <div>
                    <h3 class="font-bold">Telegram Bot not configured</h3>
                    <div class="text-sm">Set TELEGRAM_BOT_TOKEN environment variable to enable the bot.</div>
                </div>
            </div>
            {% else %}
            <div class="flex items-center gap-4 mb-4">
                <div class="text-sm text-base-content/60">Status:</div>
                <span class="badge badge-success">Running</span>
            </div>

            <!-- User Management -->
            <h3 class="font-semibold text-lg mt-4 mb-2">User Management</h3>

            <div id="telegram-users-container">
                <div class="flex items-center gap-2 mb-4">
                    <span class="loading loading-spinner"></span>
                    <span>Loading users...</span>
                </div>
            </div>

            {% endif %}
        </div>
    </div>

    <!-- System Info -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
            <h2 class="card-title">System Information</h2>
            <div class="overflow-x-auto">
                <table class="table table-sm">
                    <tbody>
                        <tr>
                            <th class="w-48">Resolution</th>
                            <td>{{ settings.resolution_str }}</td>
                        </tr>
                        <tr>
                            <th>Lobby Wait Timeout</th>
                            <td>{{ settings.lobby_wait_sec }} seconds</td>
                        </tr>
                        <tr>
                            <th>Max Recording Duration</th>
                            <td>{{ settings.max_recording_sec }} seconds</td>
                        </tr>
                        <tr>
                            <th>FFmpeg Preset</th>
                            <td>{{ settings.ffmpeg_preset }}</td>
                        </tr>
                        <tr>
                            <th>Recordings Directory</th>
                            <td class="font-mono text-sm">{{ settings.recordings_dir }}</td>
                        </tr>
                        <tr>
                            <th>Timezone</th>
                            <td>{{ settings.tz }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
let pollInterval = null;
let currentDeviceCode = null;

// YouTube Auth functions
async function startYouTubeAuth() {
    const btn = document.getElementById('start-auth-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="loading loading-spinner"></span> Starting...';

    try {
        const response = await fetch('/api/v1/youtube/auth/start', { method: 'POST' });
        const data = await response.json();

        if (data.verification_url && data.user_code && data.device_code) {
            // Store device_code for polling
            currentDeviceCode = data.device_code;

            document.getElementById('auth-url').href = data.verification_url;
            document.getElementById('auth-url').textContent = data.verification_url;
            document.getElementById('auth-code').textContent = data.user_code;
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('auth-instructions').classList.remove('hidden');

            // Start polling
            pollInterval = setInterval(pollForToken, data.interval * 1000 || 5000);
        }
    } catch (error) {
        console.error('Failed to start auth:', error);
        btn.disabled = false;
        btn.innerHTML = 'Connect YouTube Account';
    }
}

async function pollForToken() {
    if (!currentDeviceCode) {
        clearInterval(pollInterval);
        return;
    }

    try {
        const response = await fetch('/api/v1/youtube/auth/poll', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ device_code: currentDeviceCode })
        });
        const data = await response.json();

        if (data.success) {
            clearInterval(pollInterval);
            currentDeviceCode = null;
            document.getElementById('poll-status').textContent = 'Authorization successful! Reloading...';
            setTimeout(() => location.reload(), 1000);
        } else if (data.error === 'expired' || data.message?.includes('expired')) {
            clearInterval(pollInterval);
            currentDeviceCode = null;
            document.getElementById('poll-status').textContent = 'Authorization expired. Please try again.';
        }
    } catch (error) {
        console.error('Poll error:', error);
    }
}

// Telegram User Management
async function loadTelegramUsers() {
    const container = document.getElementById('telegram-users-container');
    if (!container) return;

    try {
        const response = await fetch('/api/v1/telegram/users');
        const users = await response.json();

        if (users.length === 0) {
            container.innerHTML = '<p class="text-base-content/60">No users registered yet. Users can register by messaging your bot with /start.</p>';
            return;
        }

        let html = `
            <div class="overflow-x-auto">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Chat ID</th>
                            <th>Status</th>
                            <th>Registered</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        for (const user of users) {
            const displayName = user.username ? `@${user.username}` : (user.first_name || `User ${user.chat_id}`);
            const registeredDate = user.created_at ? new Date(user.created_at).toLocaleDateString() : 'N/A';

            html += `
                <tr id="tg-user-${user.id}">
                    <td class="font-medium">${displayName}</td>
                    <td class="font-mono text-sm">${user.chat_id}</td>
                    <td>
                        ${user.approved
                            ? '<span class="badge badge-success badge-sm">Approved</span>'
                            : '<span class="badge badge-warning badge-sm">Pending</span>'
                        }
                    </td>
                    <td class="text-sm">${registeredDate}</td>
                    <td>
                        <div class="flex gap-1">
                            ${!user.approved
                                ? `<button class="btn btn-success btn-xs" onclick="approveUser(${user.id})">Approve</button>`
                                : `<button class="btn btn-warning btn-xs" onclick="revokeUser(${user.id})">Revoke</button>`
                            }
                            <button class="btn btn-error btn-xs" onclick="deleteUser(${user.id})">Delete</button>
                        </div>
                    </td>
                </tr>
            `;
        }

        html += `
                    </tbody>
                </table>
            </div>
        `;

        container.innerHTML = html;
    } catch (error) {
        console.error('Failed to load users:', error);
        container.innerHTML = '<p class="text-error">Failed to load users</p>';
    }
}

async function approveUser(userId) {
    try {
        const response = await fetch(`/api/v1/telegram/users/${userId}/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ approved_by: 'admin' })
        });
        if (response.ok) {
            loadTelegramUsers();
        }
    } catch (error) {
        console.error('Failed to approve user:', error);
    }
}

async function revokeUser(userId) {
    try {
        const response = await fetch(`/api/v1/telegram/users/${userId}/revoke`, { method: 'POST' });
        if (response.ok) {
            loadTelegramUsers();
        }
    } catch (error) {
        console.error('Failed to revoke user:', error);
    }
}

async function deleteUser(userId) {
    if (!confirm('Are you sure you want to delete this user?')) return;

    try {
        const response = await fetch(`/api/v1/telegram/users/${userId}`, { method: 'DELETE' });
        if (response.ok) {
            loadTelegramUsers();
        }
    } catch (error) {
        console.error('Failed to delete user:', error);
    }
}

// Load Telegram users on page load
document.addEventListener('DOMContentLoaded', loadTelegramUsers);
</script>
{% endblock %}
