{% extends "base.html" %}

{% block title %}{% if schedule %}Edit{% else %}New{% endif %} Schedule / MeetingRecorder{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto p-4 md:p-8 space-y-8">

    <!-- Header -->
    <div class="flex items-center gap-4">
        <button onclick="history.back()" class="btn btn-circle btn-ghost btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
        </button>
        <h1 class="text-2xl font-bold">{% if schedule and schedule.id %}Edit{% else %}New{% endif %} Schedule</h1>
    </div>

    {% if not meetings %}
    <div class="bg-[#16181c] border border-warning/30 text-warning p-4 rounded-xl flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <span>No meetings configured. <a href="/meetings/new" class="underline font-bold">Create a meeting
                first</a>.</span>
    </div>
    {% else %}

    <!-- Form -->
    <div class="bg-[#16181c] rounded-xl border border-[#2f3336] p-6">
        <form method="POST" action="/schedules/save" class="space-y-6">
            {% if schedule and schedule.id %}
            <input type="hidden" name="schedule_id" value="{{ schedule.id }}">
            <div class="text-xs text-gray-500 font-mono text-right">Updated: {{ schedule.updated_at.strftime('%Y-%m-%d
                %H:%M') if schedule.updated_at else '-' }}</div>
            {% endif %}

            <!-- Meeting Selection -->
            <div class="form-control w-full">
                <label class="label font-bold text-gray-500 text-xs uppercase tracking-wider">Meeting</label>
                <select name="meeting_id"
                    class="select select-bordered w-full bg-black border-[#2f3336] focus:border-primary rounded-lg"
                    required>
                    {% for meeting in meetings %}
                    <option value="{{ meeting.id }}" {% if schedule and schedule.meeting_id==meeting.id %}selected{%
                        endif %}>
                        {{ meeting.name }} ({{ meeting.provider | upper }})
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Schedule Type -->
                <div class="form-control w-full">
                    <label class="label font-bold text-gray-500 text-xs uppercase tracking-wider">Type</label>
                    <select name="schedule_type" id="schedule_type"
                        class="select select-bordered w-full bg-black border-[#2f3336] focus:border-primary rounded-lg"
                        required onchange="toggleScheduleFields()">
                        {% for st in schedule_types %}
                        <option value="{{ st.value }}" {% if schedule and (schedule.schedule_type.value if
                            schedule.schedule_type is not string else schedule.schedule_type)==st.value %}selected{%
                            endif %}>
                            {{ st.value | upper }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Duration Mode -->
                <div class="form-control w-full">
                    <label class="label font-bold text-gray-500 text-xs uppercase tracking-wider">Duration Mode</label>
                    <select name="duration_mode" id="duration_mode"
                        class="select select-bordered w-full bg-black border-[#2f3336] focus:border-primary rounded-lg"
                        required onchange="toggleDurationFields()">
                        <option value="fixed" {% if not schedule or schedule.duration_mode=='fixed' %}selected{% endif
                            %}>Fixed Time</option>
                        <option value="auto" {% if schedule and schedule.duration_mode=='auto' %}selected{% endif %}>
                            Auto-Detect End</option>
                    </select>
                </div>
            </div>

            <!-- Contextual Fields -->
            <div class="bg-black/50 rounded-lg p-4 border border-[#2f3336]">
                <!-- Once -->
                <div id="once-fields" class="hidden">
                    <div class="form-control w-full">
                        <label class="label font-bold text-gray-500 text-xs uppercase tracking-wider">Start Time</label>
                        <input type="datetime-local" name="start_time"
                            value="{{ schedule.start_time.strftime('%Y-%m-%dT%H:%M') if schedule and schedule.start_time else '' }}"
                            class="input input-bordered w-full bg-[#16181c] border-[#2f3336] focus:border-primary">
                    </div>
                </div>

                <!-- Cron -->
                <div id="cron-fields" class="hidden">
                    <div class="form-control w-full">
                        <label class="label font-bold text-gray-500 text-xs uppercase tracking-wider">Cron
                            Expression</label>
                        <input type="text" name="cron_expression"
                            value="{{ schedule.cron_expression if schedule else '' }}"
                            class="input input-bordered w-full bg-[#16181c] border-[#2f3336] focus:border-primary font-mono"
                            placeholder="30 14 * * 1,3">
                        <label class="label">
                            <span class="label-text-alt text-gray-600">Min Hr Day Mon Wk (0=Sun)</span>
                        </label>
                    </div>
                </div>

                <!-- Fixed Duration -->
                <div id="fixed-duration-fields" class="mt-4 hidden">
                    <div class="form-control w-full">
                        <label class="label font-bold text-gray-500 text-xs uppercase tracking-wider">Duration
                            (Minutes)</label>
                        <input type="number" name="duration_min"
                            value="{{ (schedule.duration_sec // 60) if schedule else 70 }}"
                            class="input input-bordered w-full bg-[#16181c] border-[#2f3336] focus:border-primary">
                    </div>
                </div>

                <!-- Auto Duration Info -->
                <div id="auto-duration-info" class="mt-4 hidden text-sm text-blue-400 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Recording stops when meeting ends (or max system limit).
                </div>
            </div>



            <!-- Advanced Accordion -->
            <div class="collapse collapse-plus border border-[#2f3336] bg-transparent rounded-lg">
                <input type="checkbox" />
                <div class="collapse-title font-bold text-sm text-gray-400 min-h-0 py-2 flex items-center">Advanced
                    Options</div>
                <div class="collapse-content bg-black/50 space-y-4 pt-4">

                    <div class="form-control w-full">
                        <label class="label font-bold text-gray-500 text-xs uppercase tracking-wider">Resolution</label>
                        <select name="resolution_preset" id="resolution_preset"
                            class="select select-bordered w-full bg-[#16181c] border-[#2f3336]"
                            onchange="toggleResolutionFields()">
                            <option value="1080p" {% if not schedule or (schedule.resolution_w==1920) %}selected{% endif
                                %}>1080p</option>
                            <option value="720p" {% if schedule and schedule.resolution_w==1280 %}selected{% endif %}>
                                720p</option>
                            <option value="custom" {% if schedule and schedule.resolution_w not in [1920, 1280]
                                %}selected{% endif %}>Custom</option>
                        </select>
                    </div>

                    <div id="custom-resolution-fields" class="hidden grid grid-cols-2 gap-4">
                        <input type="number" name="resolution_w" id="resolution_w"
                            value="{{ schedule.resolution_w if schedule else 1920 }}"
                            class="input input-bordered bg-[#16181c] border-[#2f3336]" placeholder="W">
                        <input type="number" name="resolution_h" id="resolution_h"
                            value="{{ schedule.resolution_h if schedule else 1080 }}"
                            class="input input-bordered bg-[#16181c] border-[#2f3336]" placeholder="H">
                    </div>

                    <div class="form-control w-full">
                        <label class="label font-bold text-gray-500 text-xs uppercase tracking-wider">Override Display
                            Name</label>
                        <input type="text" name="override_display_name"
                            value="{{ schedule.override_display_name if schedule else '' }}"
                            class="input input-bordered w-full bg-[#16181c] border-[#2f3336]">
                    </div>

                    <div class="form-control">
                        <label class="label cursor-pointer justify-start gap-3">
                            <input type="checkbox" name="dry_run" value="true" class="checkbox checkbox-warning" {% if
                                schedule and schedule.dry_run %}checked{% endif %}>
                            <span class="label-text text-warning font-bold">Dry Run (Test Mode)</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="divider border-[#2f3336]"></div>

            <!-- YouTube Section -->
            <div class="form-control">
                <label class="label cursor-pointer justify-start gap-3">
                    <input type="checkbox" name="youtube_enabled" id="youtube_enabled" value="true"
                        class="checkbox checkbox-error" onchange="toggleYouTube()" {% if schedule and
                        schedule.youtube_enabled %}checked{% endif %}>
                    <span class="label-text font-bold">Auto-upload to YouTube</span>
                </label>
            </div>

            <div id="youtube-options" class="form-control w-full pl-8 hidden">
                <select name="youtube_privacy"
                    class="select select-bordered w-full select-sm bg-black border-[#2f3336]">
                    <option value="unlisted" {% if not schedule or schedule.youtube_privacy=='unlisted' %}selected{%
                        endif %}>Unlisted</option>
                    <option value="private" {% if schedule and schedule.youtube_privacy=='private' %}selected{% endif
                        %}>Private</option>
                    <option value="public" {% if schedule and schedule.youtube_privacy=='public' %}selected{% endif %}>
                        Public</option>
                </select>
            </div>

            <div class="flex justify-end gap-3 mt-8 pt-4 border-t border-[#2f3336]">
                <button type="button" onclick="history.back()" class="btn btn-ghost rounded-full">Cancel</button>
                <button type="submit"
                    class="btn bg-[#1d9bf0] hover:bg-[#1a8cd8] text-white border-none rounded-full px-8">Save
                    Schedule</button>
            </div>
        </form>
    </div>
    {% endif %}
</div>

<script>
    function toggleDurationFields() {
        const mode = document.getElementById('duration_mode').value;
        const fixed = document.getElementById('fixed-duration-fields');
        const auto = document.getElementById('auto-duration-info');
        if (mode === 'fixed') { fixed.classList.remove('hidden'); auto.classList.add('hidden'); }
        else { fixed.classList.add('hidden'); auto.classList.remove('hidden'); }
    }

    function toggleScheduleFields() {
        const type = document.getElementById('schedule_type').value;
        const once = document.getElementById('once-fields');
        const cron = document.getElementById('cron-fields');
        // Simple logic based on value
        if (type === 'once') { once.classList.remove('hidden'); cron.classList.add('hidden'); }
        else { once.classList.add('hidden'); cron.classList.remove('hidden'); }
    }

    function toggleResolutionFields() {
        const val = document.getElementById('resolution_preset').value;
        const custom = document.getElementById('custom-resolution-fields');
        if (val === 'custom') custom.classList.remove('hidden');
        else {
            custom.classList.add('hidden');
            if (val === '1080p') { document.getElementById('resolution_w').value = 1920; document.getElementById('resolution_h').value = 1080; }
            if (val === '720p') { document.getElementById('resolution_w').value = 1280; document.getElementById('resolution_h').value = 720; }
        }
    }

    function toggleYouTube() {
        const enabled = document.getElementById('youtube_enabled').checked;
        const options = document.getElementById('youtube-options');
        if (enabled) options.classList.remove('hidden');
        else options.classList.add('hidden');
    }

    document.addEventListener('DOMContentLoaded', () => {
        toggleDurationFields();
        toggleScheduleFields();
        toggleResolutionFields();
        toggleYouTube();

        // Default start time
        const start = document.querySelector('input[name="start_time"]');
        if (start && !start.value) {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            start.value = now.toISOString().slice(0, 16);
        }
    });
</script>
{% endblock %}