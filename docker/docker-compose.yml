services:
  app:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: eyeduckai/meeting-recorder:latest
    container_name: meeting-recorder
    ports:
      - "8000:8000"
      - "${VNC_PORT:-5900}:5900"  # VNC for debugging (when DEBUG_VNC=1)
    volumes:
      - ../recordings:/app/recordings
      - ../diagnostics:/app/diagnostics
      - ../data:/app/data
    env_file:
      - ../.env
    environment:
      # These can override .env values
      - TZ=${TZ:-Asia/Taipei}
      - DATABASE_URL=${DATABASE_URL:-sqlite:///./data/app.db}
    # Required for Xvfb and PulseAudio
    privileged: true
    shm_size: '2gb'
    restart: unless-stopped

  # Development service with hot reload and VNC enabled by default
  app-dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: meeting-recorder-dev
    ports:
      - "8000:8000"
      - "5900:5900"  # VNC always exposed in dev mode
    volumes:
      - ..:/app
      - ../recordings:/app/recordings
      - ../diagnostics:/app/diagnostics
      - ../data:/app/data
    env_file:
      - ../.env
    environment:
      - DEBUG_VNC=1  # VNC enabled by default in dev mode
    privileged: true
    shm_size: '2gb'
    command: uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
    profiles:
      - dev
